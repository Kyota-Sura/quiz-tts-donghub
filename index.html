<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teka-Teki Silang (Donghua)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .identity-form {
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: left;
    }
    .identity-form label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    .identity-form input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .identity-form button {
      margin-top: 15px;
      padding: 10px 15px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .identity-form button:hover {
      background-color: #218838;
    }

    .crossword-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 35px);
      grid-template-rows: repeat(12, 35px);
      gap: 1px;
      border: 2px solid #333;
    }
    .cell {
      width: 35px;
      height: 35px;
      background: white;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      position: relative;
    }
    .cell.black {
      background: #000;
    }
    .cell input {
      width: 80%;
      height: 80%;
      border: none;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
    }
    .clues {
      text-align: left;
      max-width: 350px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .clue {
      margin: 8px 0;
      font-size: 14px;
    }
    .clue span {
      font-weight: bold;
      color: #0056b3;
    }
    button.primary {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.primary:hover {
      background-color: #0056b3;
    }
    .feedback {
      margin-top: 15px;
      font-weight: bold;
    }
    .timer {
      font-size: 18px;
      margin: 10px 0;
      font-weight: bold;
    }

    /* Leaderboard */
    .leaderboard {
      margin-top: 30px;
      width: 100%;
      max-width: 700px;
      overflow-x: auto;
      border-collapse: collapse;
      margin: 20px auto;
      display: none;
    }
    .leaderboard th {
      background-color: #007bff;
      color: white;
      padding: 10px;
      text-align: left;
    }
    .leaderboard td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .leaderboard tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .leaderboard tr:hover {
      background-color: #e9ecef;
    }
    .status-correct {
      color: green;
      font-weight: bold;
    }
    .status-wrong {
      color: red;
      font-weight: bold;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <h1>üéÆ Teka-Teki Silang (Donghua)</h1>

  <!-- Form Identitas: Hanya Discord -->
  <div class="identity-form" id="identity-form">
    <label for="player-discord">Username Discord:</label>
    <input type="text" id="player-discord" placeholder="Contoh: @kyotasura">

    <button onclick="startGame()">Mulai Main</button>
  </div>

  <!-- Timer -->
  <div class="timer" id="timer" style="display: none;">Waktu: <span id="time">00:00</span></div>

  <!-- Game TTS -->
  <div class="crossword-container" id="game-container" style="display: none;">
    <div class="grid" id="crossword-grid"></div>

    <div class="clues">
      <h3>Petunjuk Mendatar</h3>
      <div id="across-clues"></div>

      <h3>Petunjuk Menurun</h3>
      <div id="down-clues"></div>
    </div>
  </div>

  <!-- Submit Button -->
  <button id="submit-btn" class="primary" style="display: none;" onclick="submitAnswer()">
    Submit Jawaban
  </button>

  <div class="feedback" id="feedback"></div>

  <!-- Admin Button -->
  <button onclick="showAdminLeaderboard()" style="background-color: #28a745; margin-top: 20px; display: none;" id="admin-btn">
    üîê Lihat Leaderboard (Admin)
  </button>

  <!-- Leaderboard -->
  <h2 id="leaderboard-title" style="display: none;">üèÜ Leaderboard</h2>
  <table class="leaderboard" id="leaderboard-table">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nama</th>
        <th>Discord</th>
        <th>Waktu</th>
        <th>Status</th>
        <th>Skor</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <script>
    // === DATA PEMAIN ===
    let player = {
      name: "",    // Akan diisi dengan username Discord
      discord: ""
    };

    // === KONFIGURASI TTS ===
    const gridSize = 12;
    const solution = Array(gridSize).fill().map(() => Array(gridSize).fill(null));
    const cluesGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(null));

    // Fungsi untuk mengisi jawaban ke grid
    function fillSolution(word, row, col, direction) {
      for (let i = 0; i < word.length; i++) {
        if (direction === 'across') {
          solution[row][col + i] = word[i];
          cluesGrid[row][col + i] = { word, index: i };
        } else {
          solution[row + i][col] = word[i];
          cluesGrid[row + i][col] = { word, index: i };
        }
      }
    }

    // Isi grid dengan jawaban
    fillSolution("TANG SAN", 0, 0, 'across');       // 1 Mendatar
    fillSolution("GIGIT", 0, 3, 'down');            // 2 Menurun
    fillSolution("EARTHS HOPE", 2, 0, 'across');    // 3 Mendatar
    fillSolution("YA FEI", 0, 1, 'down');           // 4 Menurun
    fillSolution("ELENA", 4, 5, 'across');          // 5 Mendatar
    fillSolution("DOU LUO", 0, 5, 'down');          // 6 Menurun
    fillSolution("DELAPAN", 6, 0, 'across');        // 7 Mendatar
    fillSolution("HORNED BEAST", 0, 9, 'down');     // 8 Menurun
    fillSolution("LI ZHUE", 8, 0, 'across');        // 9 Mendatar
    fillSolution("PANG BAO", 4, 8, 'down');         // 10 Menurun

    const acrossClues = [
      { number: 1, clue: "Salah satu MC donghua terpopuler saat ini, dan pernah menggunakan nama samaran ", row: 0, col: 0 },
      { number: 3, clue: "Apa nama julukan Luo Feng yang paling famous", row: 2, col: 0 },
      { number: 5, clue: "Siapakah nama wanita yang dekat dengan Luo Feng selain Xu Xin ", row: 4, col: 5 },
      { number: 7, clue: "Berapa murid Ye Fan ", row: 6, col: 0 },
      { number: 9, clue: "Sahabat Wang Lin yang paling setia dan humoris ", row: 8, col: 0 },
      { number: 10, clue: "Sahabat Ye Fan sejak awal perjalanan", row: 4, col: 8 }
    ];

    const downClues = [
      { number: 2, clue: "Pada donghua BTTH perjanjaian 3 tahun ep 5, Xiao Yan membelikan Medusa sepatu dan manisan buah, bagaimana cara Medusa mengkonsumsi manisan tersebut?", row: 0, col: 3 },
      { number: 4, clue: "Salah satu wanita yang dekat dengan Xiao Yan dan usia lebih tua darinya", row: 0, col: 1 },
      { number: 6, clue: "Nama sistem kultivasi dalam Soul Land yang mengklasifikasikan kekuatan seseorang berdasarkan roh perang", row: 0, col: 5 },
      { number: 8, clue: "Apa nama hewan langka yang menjadi tubuh ke dua Shi Hao", row: 0, col: 9 }
    ];

    let startTime, endTime;
    let timerInterval;
    let isCorrect = false;
    let gameStarted = false;

    // === CEK APAKAH SUDAH LOGIN ===
    function checkLoginStatus() {
      const savedPlayer = localStorage.getItem("tts-player");
      const savedStartTime = localStorage.getItem("tts-start-time");
      
      if (savedPlayer) {
        player = JSON.parse(savedPlayer);
        gameStarted = true;
        
        // Tampilkan game
        document.getElementById("timer").style.display = "block";
        document.getElementById("game-container").style.display = "flex";
        document.getElementById("submit-btn").style.display = "block";
        document.getElementById("admin-btn").style.display = "block";
        document.getElementById("identity-form").style.display = "none";
        
        // Mulai permainan
        renderGrid();
        renderClues();
        startTimer();
      }
    }

    // === MULAI GAME ===
    function startGame() {
      const discord = document.getElementById("player-discord").value.trim();

      if (!discord) {
        alert("Mohon isi username Discord!");
        return;
      }

      // Gunakan username Discord sebagai nama
      player.name = discord;
      player.discord = discord;
      
      // Simpan data pemain
      localStorage.setItem("tts-player", JSON.stringify(player));

      // Simpan waktu mulai ke localStorage
      const now = new Date().getTime();
      localStorage.setItem("tts-start-time", now.toString());
      
      gameStarted = true;
      
      // Tampilkan game
      document.getElementById("timer").style.display = "block";
      document.getElementById("game-container").style.display = "flex";
      document.getElementById("submit-btn").style.display = "block";
      document.getElementById("admin-btn").style.display = "block";
      document.getElementById("identity-form").style.display = "none";

      // Mulai permainan
      renderGrid();
      renderClues();
      startTimer();
    }

    // === RENDER GRID ===
    function renderGrid() {
      const grid = document.getElementById("crossword-grid");
      grid.innerHTML = "";

      for (let row = 0; row < gridSize; row++) {
        for (let col = 0; col < gridSize; col++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (solution[row][col] === null) {
            cell.classList.add("black");
          } else {
            const input = document.createElement("input");
            input.type = "text";
            input.maxLength = 1;
            input.dataset.row = row;
            input.dataset.col = col;
            input.addEventListener("input", function () {
              this.value = this.value.toUpperCase();
            });
            cell.appendChild(input);

            // Tambah nomor clue
            const clue = acrossClues.find(c => c.row === row && c.col === col) || 
                         downClues.find(c => c.row === row && c.col === col);
            if (clue) {
              const numLabel = document.createElement("span");
              numLabel.textContent = clue.number;
              numLabel.style.position = "absolute";
              numLabel.style.top = "2px";
              numLabel.style.left = "2px";
              numLabel.style.fontSize = "8px";
              numLabel.style.color = "blue";
              cell.appendChild(numLabel);
            }
          }
          grid.appendChild(cell);
        }
      }
    }

    // === TAMPILKAN PETUNJUK ===
    function renderClues() {
      const acrossEl = document.getElementById("across-clues");
      const downEl = document.getElementById("down-clues");
      acrossEl.innerHTML = "";
      downEl.innerHTML = "";

      acrossClues.forEach(clue => {
        const p = document.createElement("p");
        p.className = "clue";
        p.innerHTML = `<span>${clue.number} Mendatar:</span> ${clue.clue}`;
        acrossEl.appendChild(p);
      });

      downClues.forEach(clue => {
        const p = document.createElement("p");
        p.className = "clue";
        p.innerHTML = `<span>${clue.number} Menurun:</span> ${clue.clue}`;
        downEl.appendChild(p);
      });
    }

    // === TIMER ===
    function startTimer() {
      // Cek apakah ada waktu mulai tersimpan
      const savedStartTime = localStorage.getItem("tts-start-time");
      if (savedStartTime) {
        startTime = new Date(parseInt(savedStartTime));
      } else {
        startTime = new Date();
        localStorage.setItem("tts-start-time", startTime.getTime().toString());
      }

      timerInterval = setInterval(() => {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById("time").textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // === SUBMIT JAWABAN ===
    function submitAnswer() {
      const inputs = document.querySelectorAll(".cell input");
      let correctCount = 0;
      let totalLetters = 0;

      inputs.forEach(input => {
        const row = parseInt(input.dataset.row);
        const col = parseInt(input.dataset.col);
        const user = input.value.toUpperCase();
        const correctChar = solution[row][col];

        if (correctChar !== null) {
          totalLetters++;
          if (user === correctChar) {
            correctCount++;
            input.style.backgroundColor = "#d4edda";
          } else {
            input.style.backgroundColor = "#f8d7da";
          }
        }
      });

      isCorrect = (correctCount === totalLetters);
      endTime = new Date();
      clearInterval(timerInterval);

      // Hapus data dari localStorage setelah selesai
      localStorage.removeItem("tts-start-time");
      localStorage.removeItem("tts-player");

      const feedback = document.getElementById("feedback");
      if (isCorrect) {
        feedback.innerHTML = "üéâ <b>Semua jawaban benar!</b>";
      } else {
        const accuracy = ((correctCount / totalLetters) * 100).toFixed(1);
        feedback.innerHTML = `‚ùå <b>${correctCount}/${totalLetters}</b> huruf benar. Akurasi: <b>${accuracy}%</b>.`;
      }

      saveToLeaderboard();
      
      // Reset game state
      gameStarted = false;
    }

    // === SIMPAN KE LEADERBOARD ===
    function saveToLeaderboard() {
      // Hitung waktu berdasarkan startTime yang tersimpan
      const savedStartTime = localStorage.getItem("tts-start-time");
      if (savedStartTime) {
        startTime = new Date(parseInt(savedStartTime));
      }
      
      const timeElapsed = (endTime - startTime) / 1000;
      const score = Math.round((isCorrect ? 1000 : 500) / (timeElapsed / 10 + 1));

      const entry = {
        name: player.name,
        discord: player.discord,
        time: timeElapsed.toFixed(1),
        status: isCorrect ? "Benar" : "Salah",
        score
      };

      let leaderboard = JSON.parse(localStorage.getItem("tts-leaderboard")) || [];
      leaderboard.push(entry);

      // Urutkan: yang benar dulu, lalu skor tertinggi
      leaderboard.sort((a, b) => {
        if (a.status !== b.status) return a.status === "Benar" ? -1 : 1;
        return b.score - a.score;
      });

      // Batasi 20
      leaderboard = leaderboard.slice(0, 20);
      localStorage.setItem("tts-leaderboard", JSON.stringify(leaderboard));

      alert(`Terima kasih, ${player.name}! Jawaban kamu telah dikirim ke leaderboard.`);
    }

    // === LIHAT LEADERBOARD (ADMIN) ===
    function showAdminLeaderboard() {
      const password = prompt("Masukkan password admin:");
      if (password !== "77506720") {
        alert("Password salah!");
        return;
      }

      const leaderboard = JSON.parse(localStorage.getItem("tts-leaderboard")) || [];
      const tbody = document.getElementById("leaderboard-body");
      tbody.innerHTML = "";

      leaderboard.forEach((entry, index) => {
        const rank = index + 1;
        const medal = rank === 1 ? "ü•á" : rank === 2 ? "ü•à" : rank === 3 ? "ü•â" : rank;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${medal}</b></td>
          <td>${entry.name}</td>
          <td><code>${entry.discord}</code></td>
          <td>${entry.time}s</td>
          <td class="${entry.status === 'Benar' ? 'status-correct' : 'status-wrong'}">
            ${entry.status}
          </td>
          <td><b>${entry.score}</b></td>
          <td><button class="delete-btn" onclick="deleteEntry(this)">üóëÔ∏è Hapus</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("leaderboard-title").style.display = "block";
      document.querySelector(".leaderboard").style.display = "table";
    }

    // === HAPUS ENTRI DARI LEADERBOARD ===
    function deleteEntry(button) {
      if (!confirm("Apakah kamu yakin ingin menghapus entri ini?")) {
        return;
      }

      const row = button.closest('tr');
      const name = row.cells[1].textContent;
      const discord = row.cells[2].textContent;

      let leaderboard = JSON.parse(localStorage.getItem("tts-leaderboard")) || [];
      leaderboard = leaderboard.filter(entry => entry.name !== name || entry.discord !== discord);

      localStorage.setItem("tts-leaderboard", JSON.stringify(leaderboard));

      // Hapus baris dari tabel
      row.remove();

      alert("‚úÖ Entri berhasil dihapus!");
    }

    // === HANDLE TAB/APP SWITCH ===
    window.addEventListener('beforeunload', function() {
      // Timer tetap berjalan karena menggunakan localStorage
    });

    // === CEK STATUS LOGIN SAAT HALAMAN DIMUAT ===
    window.addEventListener('load', function() {
      checkLoginStatus();
    });
  </script>
</body>
</html>
